<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Behaviour Theory Navigator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* General layout styles */
        .view {
            width: 100%;
            height: 100vh;
            overflow-y: auto;
        }
        /* Graph specific styles */
        .graph-container {
            width: 100%;
            height: 100%;
            touch-action: none;
        }
        .node {
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        .node-label {
            pointer-events: none;
            font-size: 10px;
            fill: #E5E7EB; /* gray-200 */
        }
        .link {
            stroke-opacity: 0.6;
        }
        .node.highlight circle {
            stroke: #FBBF24; /* amber-400 */
            stroke-width: 3px;
        }
        .link.highlight {
            stroke: #FBBF24; /* amber-400 */
            stroke-opacity: 1;
            stroke-width: 2.5px;
        }
        .node:not(.highlight-neighbor) circle,
        .link:not(.highlight) {
            transition: opacity 0.3s ease;
        }
        body.selecting .node:not(.highlight):not(.highlight-neighbor) {
            opacity: 0.2;
        }
        body.selecting .link:not(.highlight) {
            opacity: 0.1;
        }
        .node.highlight-neighbor circle {
            stroke: #FBBF24; /* amber-400 */
            stroke-width: 1.5px;
            stroke-opacity: 0.8;
        }
        /* Utility for text clamping */
        .line-clamp-3 {
            overflow: hidden;
            display: -webkit-box;
            -webkit-box-orient: vertical;
            -webkit-line-clamp: 3;
        }
        /* Pagination Styles */
        .pagination-btn {
            @apply flex items-center justify-center px-4 h-10 text-sm font-medium text-gray-300 bg-gray-800 rounded-lg hover:bg-gray-700 hover:text-white transition-colors;
        }
        .pagination-btn:disabled {
            @apply opacity-50 cursor-not-allowed hover:bg-gray-800;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100">

    <!-- View for listing all theories -->
    <div id="list-view" class="view p-4 md:p-8">
        <h1 class="text-3xl md:text-4xl font-bold text-white mb-2">Theories of Behaviour Change</h1>
        <p class="text-gray-400 mb-6">Select a theory to explore its interactive graph, or show the data input to load your own JSON.</p>

        <!-- JSON Input Section (hidden by default) -->
        <button id="toggle-json-btn" class="mb-4 bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">
            Show Data Input
        </button>
        <div id="json-input-container" class="mb-6 hidden">
            <label for="json-input" class="block mb-2 text-sm font-medium text-gray-300">Theory Data (JSON format)</label>
            <textarea id="json-input" rows="8" class="block p-2.5 w-full text-sm text-gray-200 bg-gray-800 rounded-lg border border-gray-600 focus:ring-sky-500 focus:border-sky-500"></textarea>
            <div class="flex items-center mt-2">
                <button id="load-json-btn" class="bg-sky-600 hover:bg-sky-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                    Load & Display Theories from Textarea
                </button>
                <span id="json-status" class="ml-4 text-sm"></span>
            </div>
        </div>
        
        <hr class="border-gray-700 my-8">

        <!-- Theory List Section -->
        <h2 class="text-2xl font-bold text-white mb-4">Available Theories</h2>
        <div id="theory-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 min-h-[300px]">
            <!-- Theory cards will be populated by JavaScript -->
        </div>
        <!-- Pagination Controls -->
        <div id="pagination-container" class="mt-8 flex justify-between items-center">
            <!-- Pagination buttons will be populated by JavaScript -->
        </div>
    </div>

    <!-- View for displaying a single theory graph -->
    <div id="graph-view" class="hidden view flex-col md:flex-row h-screen max-h-screen overflow-hidden">
        <!-- Main Graph Section -->
        <main class="flex-grow flex flex-col relative" id="graph-area">
            <div class="p-4 bg-gray-900/80 backdrop-blur-sm border-b border-gray-700 flex justify-between items-center">
                <div>
                    <h1 id="theory-title" class="text-xl md:text-2xl font-bold text-white"></h1>
                    <p class="text-sm text-gray-400">Click on any concept (node) to explore. Drag to rearrange.</p>
                </div>
                <button id="back-to-list" class="bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-4 rounded-lg transition-colors flex-shrink-0">
                    &larr; Back to List
                </button>
            </div>
            <div id="graph-container" class="flex-grow bg-gray-800/20"></div>
            <div class="p-4 text-xs text-gray-500 border-t border-gray-700 overflow-y-auto max-h-24">
                <strong>Description:</strong> <span id="theory-description-text"></span>
            </div>
        </main>

        <!-- Info Panel Section -->
        <aside id="info-panel" class="w-full md:w-96 bg-gray-800 shadow-lg p-6 flex-shrink-0 overflow-y-auto border-l border-gray-700">
            <div id="info-content" class="sticky top-6">
                 <!-- Content will be populated by JS -->
            </div>
        </aside>
    </div>

    <script>
        // --- EMBEDDED DATA ---
        // This makes the HTML file self-contained and portable.
        const defaultTheoryData = [{"id":1,"name":"Action Theory Model of Consumption","description":"The Action Theory Model of Consumption posits that goal-directed consumer behaviors are driven by a complex interplay of cognitive and affective processes initiated by various antecedents. \n\nDesire to engage in a specific consumption behavior is directly influenced by attitudes, subjective norms, goal intentions (themselves shaped by the desirability and feasibility of those goals), somatic marker processes stemming from previous emotional experiences, moral imperatives, social identity processes, and frequency of past behavior. \n\nThis desire, along with perceived behavioral control, then shapes implementation intentions, which, in turn, along with perceived behavioural control, positively influence trying to perform the behavior. Trying and perceived behavioural control then jointly lead to the performance of goal-directed behaviors, ultimately resulting in goal attainment or failure, which provides feedback that informs future antecedents and subsequent behaviors. \n\nFurthermore, the model emphasizes the modulating role of self-conscious and moral emotions, individual virtues and values, empathy, and social/personal identity in strengthening the relationship between implementation intentions and trying, and further moderating the relationship between desire and implementation intentions. Situational forces modulate the impact of performance on goal attainment/failure. Ultimately, this dynamic system proposes that consumption is a process continuously shaped by cognitive evaluations, affective responses, social influences, and the outcomes of past actions.","picture_path":"C:/Users/Ghoar/Desktop/Thought Forms/Behavioral Theory Data Entry/1.png","complete":true,"constructs":[{"name":"Somatic marker processes","description":""},{"name":"Anticipated emotions","description":""},{"name":"Desire","description":""},{"name":"Perceived behavioural control","description":""},{"name":"Implementation intentions","description":""},{"name":"Trying","description":""},{"name":"Goal attainment / failure","description":""},{"name":"Feedback","description":""},{"name":"Goal intention","description":""},{"name":"Subjective norms","description":""},{"name":"Attitudes","description":""},{"name":"Performance of goal-directed behaviours","description":""},{"name":"Antecedents of goal-directed behaviour","description":""},{"name":"Frequency of past behaviour","description":""},{"name":"Moral imperatives","description":""},{"name":"Social identity processes","description":""},{"name":"Low","description":""},{"name":"Situational Forces","description":""},{"name":"Recency of past behaviour","description":""},{"name":"High","description":""},{"name":"Self-conscious emotions","description":""},{"name":"Moral emotions","description":""},{"name":"Virtues, values, other individual differences","description":""},{"name":"Empathy","description":""},{"name":"Social and personal identity","description":""},{"name":"Desirability","description":""},{"name":"Feasibility of goals","description":""},{"name":"Previous emotional experiences with behaviour","description":""},{"name":"Normative beliefs","description":""},{"name":"Motivation to comply","description":""},{"name":"Beliefs","description":""},{"name":"Evaluations","description":""}],"triples":[{"subject":"Somatic marker processes","predicate":"influences","object":"Anticipated emotions"},{"subject":"Anticipated emotions","predicate":"influences","object":"Desire"},{"subject":"Perceived behavioural control","predicate":"influences","object":"Desire"},{"subject":"Implementation intentions","predicate":"positively influences","object":"Trying"},{"subject":"Goal attainment / failure","predicate":"influences","object":"Feedback"},{"subject":"Goal intention","predicate":"positively influences","object":"Desire"},{"subject":"Subjective norms","predicate":"influences","object":"Desire"},{"subject":"Attitudes","predicate":"influences","object":"Desire"},{"subject":"Trying","predicate":"positively influences","object":"Performance of goal-directed behaviours"},{"subject":"Perceived behavioural control","predicate":"positively influences","object":"Performance of goal-directed behaviours"},{"subject":"Perceived behavioural control","predicate":"positively influences","object":"Trying"},{"subject":"Desire","predicate":"influences","object":"Implementation intentions"},{"subject":"Feedback","predicate":"influences","object":"Antecedents of goal-directed behaviour"},{"subject":"Frequency of past behaviour","predicate":"influences","object":"Desire"},{"subject":"Moral imperatives","predicate":"influences","object":"Desire"},{"subject":"Social identity processes","predicate":"influences","object":"Desire"},{"subject":"Social identity processes","predicate":"influences","object":"Implementation intentions"},{"subject":"Low","predicate":"influences","object":"Implementation intentions"},{"subject":"Performance of goal-directed behaviours","predicate":"influences","object":"Goal attainment / failure"},{"subject":"Situational Forces","predicate":"influences","object":"the 'Performance of goal-directed behaviours' to 'Goal attainment / failure' Influences relationship"},{"subject":"Recency of past behaviour","predicate":"positively influences","object":"Performance of goal-directed behaviours"},{"subject":"High","predicate":"influences","object":"Performance of goal-directed behaviours"},{"subject":"Perceived behavioural control","predicate":"influences","object":"Implementation intentions"},{"subject":"Self-conscious emotions","predicate":"influences","object":"the 'Implementation intentions' to 'Trying' Positively influences relationship"},{"subject":"Moral emotions","predicate":"influences","object":"the 'Implementation intentions' to 'Trying' Positively influences relationship"},{"subject":"Virtues, values, other individual differences","predicate":"influences","object":"the 'Implementation intentions' to 'Trying' Positively influences relationship"},{"subject":"Empathy","predicate":"influences","object":"the 'Implementation intentions' to 'Trying' Positively influences relationship"},{"subject":"Social and personal identity","predicate":"influences","object":"the 'Implementation intentions' to 'Trying' Positively influences relationship"},{"subject":"Social and personal identity","predicate":"influences","object":"the 'Desire' to 'Implementation intentions' Influences relationship"},{"subject":"Empathy","predicate":"influences","object":"the 'Desire' to 'Implementation intentions' Influences relationship"},{"subject":"Virtues, values, other individual differences","predicate":"influences","object":"the 'Desire' to 'Implementation intentions' Influences relationship"},{"subject":"Moral emotions","predicate":"influences","object":"the 'Desire' to 'Implementation intentions' Influences relationship"},{"subject":"Self-conscious emotions","predicate":"influences","object":"the 'Desire' to 'Implementation intentions' Influences relationship"},{"subject":"Desirability","predicate":"influences","object":"(*) Goal intention"},{"subject":"Feasibility of goals","predicate":"influences","object":"(*) Goal intention"},{"subject":"Previous emotional experiences with behaviour","predicate":"part of","object":"Somatic marker processes"},{"subject":"Normative beliefs","predicate":"influences","object":"(*) Subjective norms"},{"subject":"Motivation to comply","predicate":"influences","object":"(*) Subjective norms"},{"subject":"Beliefs","predicate":"influences","object":"(*) Attitudes"},{"subject":"Beliefs","predicate":"influences","object":"(*) Subjective norms"},{"subject":"Evaluations","predicate":"influences","object":"(*) Attitudes"},{"subject":"Evaluations","predicate":"influences","object":"(*) Subjective norms"},{"subject":"Subjective norms","predicate":"part of","object":"Antecedents of goal-directed behaviour"},{"subject":"Anticipated emotions","predicate":"part of","object":"Antecedents of goal-directed behaviour"},{"subject":"Social identity processes","predicate":"part of","object":"Antecedents of goal-directed behaviour"},{"subject":"Somatic marker processes","predicate":"part of","object":"Antecedents of goal-directed behaviour"},{"subject":"Goal intention","predicate":"part of","object":"Antecedents of goal-directed behaviour"},{"subject":"Attitudes","predicate":"part of","object":"Antecedents of goal-directed behaviour"},{"subject":"Perceived behavioural control","predicate":"part of","object":"Antecedents of goal-directed behaviour"},{"subject":"Desire","predicate":"part of","object":"Antecedents of goal-directed behaviour"},{"subject":"Frequency of past behaviour","predicate":"part of","object":"Antecedents of goal-directed behaviour"},{"subject":"Moral imperatives","predicate":"part of","object":"Antecedents of goal-directed behaviour"},{"subject":"Implementation intentions","predicate":"part of","object":"Antecedents of goal-directed behaviour"},{"subject":"Trying","predicate":"part of","object":"Antecedents of goal-directed behaviour"},{"subject":"Recency of past behaviour","predicate":"part of","object":"Antecedents of goal-directed behaviour"},{"subject":"Desirability","predicate":"part of","object":"Antecedents of goal-directed behaviour"},{"subject":"Feasibility of goals","predicate":"part of","object":"Antecedents of goal-directed behaviour"},{"subject":"Normative beliefs","predicate":"part of","object":"Antecedents of goal-directed behaviour"},{"subject":"Motivation to comply","predicate":"part of","object":"Antecedents of goal-directed behaviour"},{"subject":"Beliefs","predicate":"part of","object":"Antecedents of goal-directed behaviour"},{"subject":"Evaluations","predicate":"part of","object":"Antecedents of goal-directed behaviour"},{"subject":"High","predicate":"part of","object":"Frequency of past behaviour"},{"subject":"Low","predicate":"part of","object":"Frequency of past behaviour"}],"annotations":[{"construct":"Somatic marker processes","relation":"BCIO:050564","value":"Affective attitude acquired through association","source":"1"},{"construct":"Anticipated emotions","relation":"BCIO:050590","value":"Belief about emotional consequences of goal attainment","source":"1"},{"construct":"Desire","relation":"MF:0000045","value":"Wanting","source":"1"},{"construct":"Desire","relation":"BCIO:006075","value":"Subjective need","source":"1 82 69 22 5"},{"construct":"Perceived behavioural control","relation":"BCIO:006034","value":"Belief about voluntariness of behaviour","source":"1"},{"construct":"Perceived behavioural control","relation":"MFOEM:000075","value":"Appraisal of causal agency","source":"1 80"},{"construct":"Implementation intentions","relation":"BCIO:006016","value":"Behavioural intention","source":"1 66 14 59 73 72 23 77 69 52 81 74 79 80 3 24 18"},{"construct":"Trying","relation":"BCIO:006096","value":"Goal pursuit process","source":"1 17 53 3 10"},{"construct":"Feedback","relation":"BCIO:007023","value":"Provide feedback on behaviour BCT","source":"1"},{"construct":"Goal intention","relation":"BCIO:006016","value":"Behavioural intention","source":"1 66 14 59 73 72 23 77 69 52 81 74 79 80 3 24 18"},{"construct":"Subjective norms","relation":"BCIO:006042","value":"Normative belief","source":"1"},{"construct":"Subjective norms","relation":"BCIO:006059","value":"Willingness to comply","source":"1 3 79 66 73 35 81 80 72 14"},{"construct":"Attitudes","relation":"BCIO:050328","value":"Attitude","source":"1 72 4 80 2 29 64 35"},{"construct":"Performance of goal-directed behaviours","relation":"BCIO:050818","value":"Goal-directed behaviour","source":"1 53"},{"construct":"Frequency of past behaviour","relation":"BCIO:050817","value":"Frequency of past behaviour","source":"1"},{"construct":"Moral imperatives","relation":"BCIO:006063","value":"Personal value","source":"1 42 83 69 75"},{"construct":"Social identity processes","relation":"BCIO:050775","value":"Social identity process","source":"1"},{"construct":"Situational Forces","relation":"BCIO:006086","value":"Opportunity","source":"1 73 25 32 11 4 60 67 65 59 8 74 66 41 5 77 56 9 12 79"},{"construct":"Self-conscious emotions","relation":"MFOEM:000001","value":"Emotional process","source":"1"},{"construct":"Moral emotions","relation":"MFOEM:000001","value":"Emotional process","source":"1"},{"construct":"Virtues, values, other individual differences","relation":"MF:0000203","value":"personality trait","source":"1 49"},{"construct":"Empathy","relation":"MF:0000203","value":"personality trait","source":"1 49"},{"construct":"Social and personal identity","relation":"BCIO:006051","value":"Social identity","source":"1"},{"construct":"Social and personal identity","relation":"ADDICTO:0000381","value":"identity","source":"1"},{"construct":"Desirability","relation":"BCIO:050617","value":"comparative desirability appraisal","source":"1"},{"construct":"Feasibility of goals","relation":"BCIO:050592","value":"belief about goal attainment","source":"1"},{"construct":"Previous emotional experiences with behaviour","relation":"MFOEM:000001","value":"emotion process","source":"1"},{"construct":"Normative beliefs","relation":"BCIO:006042","value":"Normative belief","source":"1 79 73 35 81 3 14"},{"construct":"Motivation to comply","relation":"BCIO:006059","value":"Willingness to comply","source":"1 3 66 80 79 72"},{"construct":"Beliefs","relation":"MF:0000041","value":"belief","source":"1"},{"construct":"Beliefs","relation":"BCIO:006019","value":"Belief about consequences of behaviour","source":"1 72 33 74 79 32 34 73 55 80 14 28 30 31 35 42 54 67"},{"construct":"Evaluations","relation":"BCIO:006038","value":"Evaluative belief","source":"1"},{"construct":"Evaluations","relation":"BCIO:006148","value":"Evaluative belief about the consequences of a behaviour","source":"1 77 42 39 66 80 53 64 55 35 74 12 14 79"}]},{"id":2,"name":"Affective Events Theory","description":"Affective Events Theory (AET) posits that workplace behaviors are driven by both cognitive and emotional processes stemming from the work environment. \n\nSpecifically, AET proposes that features of the work environment shape work events, which in turn trigger affective reactions in employees. These affective reactions, alongside the direct influence of the work environment, impact work attitudes, subsequently influencing judgement-driven behaviors. \n\nCritically, affective reactions also directly influence affect-driven behaviors. Individual dispositions moderate the relationship between work events and affective reactions, as well as directly impacting affective reactions, thus highlighting the role of personality in shaping emotional responses and ultimately, work behaviors. \n\nIn essence, AET underscores the importance of understanding the interplay between environmental stimuli, emotional responses, attitudes, and dispositional factors in predicting workplace behavior.","picture_path":"C:/Users/Ghoar/Desktop/Thought Forms/Behavioral Theory Data Entry/2.png","complete":true,"constructs":[{"name":"Work environment features","description":""},{"name":"Work events","description":""},{"name":"Affective reactions","description":""},{"name":"Work attitudes","description":""},{"name":"Judgement-driven behaviours","description":""},{"name":"Affect-driven behaviours","description":""},{"name":"Dispositions","description":""}],"triples":[{"subject":"Work environment features","predicate":"influences","object":"Work events"},{"subject":"Work events","predicate":"influences","object":"Affective reactions"},{"subject":"Affective reactions","predicate":"influences","object":"Work attitudes"},{"subject":"Work attitudes","predicate":"influences","object":"Judgement-driven behaviours"},{"subject":"Affective reactions","predicate":"influences","object":"Affect-driven behaviours"},{"subject":"Dispositions","predicate":"influences","object":"the 'Work events' to 'Affective reactions' Influences relationship"},{"subject":"Dispositions","predicate":"influences","object":"Affective reactions"},{"subject":"Work environment features","predicate":"influences","object":"Work attitudes"},{"subject":"Work environment features","predicate":"influences","object":"Work events"},{"subject":"Work events","predicate":"influences","object":"Affective reactions"},{"subject":"Work attitudes","predicate":"influences","object":"Judgement-driven behaviours"},{"subject":"Work environment features","predicate":"influences","object":"Work attitudes"},{"subject":"Affective reactions","predicate":"influences","object":"Affect-driven behaviours"},{"subject":"Dispositions","predicate":"influences","object":"Affective reactions"},{"subject":"Affective reactions","predicate":"influences","object":"Work attitudes"}],"annotations":[{"construct":"Work environment features","relation":"ENVO:01000254","value":"Environmental system","source":"2 56 47 76 49 72 60 58 67 63 46 4 17 5 66 9 3 10 14"},{"construct":"Work events","relation":"ENVO:01000254","value":"Environmental system","source":"2 56 47 76 49 72 60 58 67 63 46 4 17 5 66 9 3 10 14"},{"construct":"Affective reactions","relation":"MFOEM:000001","value":"Emotion process","source":"2 17"},{"construct":"Work attitudes","relation":"BCIO:050328","value":"Attitude","source":"2 72 4 80 1 29 64 35"},{"construct":"Judgement-driven behaviours","relation":"BCIO:050832","value":"Reflective behaviour","source":"2"},{"construct":"Affect-driven behaviours","relation":"BCIO:050813","value":"Emotional behaviour","source":"2"},{"construct":"Dispositions","relation":"MFOEM:000204","value":"emotional personality trait","source":"2"}]}];
        // ... (The rest of the 74 theories would be here)

        // --- GLOBAL STATE & DOM ELEMENTS ---
        let allTheories = [];
        let currentPage = 1;
        const itemsPerPage = 10;

        const listView = document.getElementById('list-view');
        const graphView = document.getElementById('graph-view');
        const theoryListContainer = document.getElementById('theory-list');
        const paginationContainer = document.getElementById('pagination-container');
        const jsonInput = document.getElementById('json-input');
        const jsonInputContainer = document.getElementById('json-input-container');
        const toggleJsonBtn = document.getElementById('toggle-json-btn');
        const loadJsonBtn = document.getElementById('load-json-btn');
        const jsonStatus = document.getElementById('json-status');
        const backButton = document.getElementById('back-to-list');
        const theoryTitleEl = document.getElementById('theory-title');
        const theoryDescriptionEl = document.getElementById('theory-description-text');
        const infoPanelContent = document.getElementById('info-content');
        const graphContainer = document.getElementById('graph-container');

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            // Pre-fill the textarea with the default data
            jsonInput.value = JSON.stringify(defaultTheoryData, null, 2);
            
            // Initial load of data from the default variable
            loadDefaultData();

            loadJsonBtn.addEventListener('click', processAndRenderData);
            toggleJsonBtn.addEventListener('click', () => {
                const isHidden = jsonInputContainer.classList.toggle('hidden');
                toggleJsonBtn.textContent = isHidden ? 'Show Data Input' : 'Hide Data Input';
            });
            backButton.addEventListener('click', showListView);
        });

        // --- VIEW MANAGEMENT & DATA HANDLING ---
        
        /**
         * Loads theories from the default embedded data variable on page load.
         */
        function loadDefaultData() {
            try {
                allTheories = defaultTheoryData; // Use the variable directly
                if (!Array.isArray(allTheories)) {
                    throw new Error("Default data is not a valid array.");
                }
                currentPage = 1; 
                displayPage(currentPage);
                jsonStatus.textContent = `Successfully loaded ${allTheories.length} default theories.`;
                jsonStatus.className = 'ml-4 text-sm text-green-400';
            } catch(error) {
                console.error("Error loading default data:", error);
                jsonStatus.textContent = `Error: Invalid default data format.`;
                jsonStatus.className = 'ml-4 text-sm text-red-400';
            }
        }
        
        /**
         * Parses the JSON from the textarea and updates the UI.
         */
        function processAndRenderData() {
            try {
                allTheories = JSON.parse(jsonInput.value);
                if (!Array.isArray(allTheories)) {
                    throw new Error("JSON data must be an array of theories.");
                }
                currentPage = 1; // Reset to first page
                displayPage(currentPage);
                jsonStatus.textContent = `Successfully loaded ${allTheories.length} theories from textarea.`;
                jsonStatus.className = 'ml-4 text-sm text-green-400';
            } catch (error) {
                console.error("Error parsing JSON:", error);
                jsonStatus.textContent = `Error: Invalid JSON format. ${error.message}`;
                jsonStatus.className = 'ml-4 text-sm text-red-400';
                theoryListContainer.innerHTML = ''; // Clear list on error
                paginationContainer.innerHTML = ''; // Clear pagination on error
            }
        }

        /**
         * Displays a specific page of theories and updates pagination controls.
         * @param {number} page - The page number to display.
         */
        function displayPage(page) {
            currentPage = page;
            const startIndex = (page - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedTheories = allTheories.slice(startIndex, endIndex);

            populateTheoryList(paginatedTheories);
            setupPaginationControls(allTheories.length, page);
        }

        /**
         * Populates the main list view with cards for a given page of theories.
         * @param {Array<object>} theories - The array of theory objects for the current page.
         */
        function populateTheoryList(theories) {
            theoryListContainer.innerHTML = ''; // Clear previous page
            if (theories.length === 0) {
                 theoryListContainer.innerHTML = '<p class="text-gray-400 col-span-full">No theories to display.</p>';
                 return;
            }
            theories.forEach(theory => {
                const card = document.createElement('div');
                card.className = 'bg-gray-800 p-4 rounded-lg shadow-lg cursor-pointer hover:bg-gray-700 hover:scale-105 transition-all duration-200 flex flex-col justify-between';
                card.innerHTML = `
                    <div>
                        <h3 class="font-bold text-sky-400">${theory.id}. ${theory.name}</h3>
                        <p class="text-sm text-gray-400 mt-2 line-clamp-3">${theory.description || 'No description available.'}</p>
                    </div>
                `;
                card.addEventListener('click', () => showGraphView(theory));
                theoryListContainer.appendChild(card);
            });
        }
        
        /**
         * Creates and manages the pagination buttons.
         * @param {number} totalItems - Total number of theories.
         * @param {number} currentPage - The currently active page.
         */
        function setupPaginationControls(totalItems, page) {
            paginationContainer.innerHTML = '';
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            if (totalPages <= 1) return;

            // Previous Button
            const prevButton = document.createElement('button');
            prevButton.innerHTML = '&larr; Previous';
            prevButton.className = 'pagination-btn';
            prevButton.disabled = page === 1;
            prevButton.addEventListener('click', () => displayPage(page - 1));
            paginationContainer.appendChild(prevButton);

            // Page Info
            const pageInfo = document.createElement('span');
            pageInfo.className = 'text-sm text-gray-400';
            pageInfo.textContent = `Page ${page} of ${totalPages}`;
            paginationContainer.appendChild(pageInfo);

            // Next Button
            const nextButton = document.createElement('button');
            nextButton.innerHTML = 'Next &rarr;';
            nextButton.className = 'pagination-btn';
            nextButton.disabled = page === totalPages;
            nextButton.addEventListener('click', () => displayPage(page + 1));
            paginationContainer.appendChild(nextButton);
        }

        function showListView() {
            graphView.classList.add('hidden');
            graphView.classList.remove('flex');
            listView.classList.remove('hidden');
        }

        function showGraphView(theory) {
            listView.classList.add('hidden');
            graphView.classList.remove('hidden');
            graphView.classList.add('flex');

            theoryTitleEl.textContent = theory.name;
            theoryDescriptionEl.textContent = theory.description || "No description provided.";
            
            const annotationMap = new Map();
            if (theory.annotations) {
                theory.annotations.forEach(ann => {
                    if (!annotationMap.has(ann.construct)) {
                        annotationMap.set(ann.construct, []);
                    }
                    annotationMap.get(ann.construct).push(`${ann.relation}: ${ann.value} [${ann.source}]`);
                });
            }

            const nodes = theory.constructs.map(c => ({
                id: c.name.trim(),
                annotation: annotationMap.has(c.name.trim()) ? annotationMap.get(c.name.trim()).join('<br>') : "No annotation available"
            }));

            const nodeMap = new Map(nodes.map(node => [node.id, node]));

            const links = theory.triples.map(triple => {
                const source = triple.subject.trim();
                const predicate = triple.predicate.trim();
                let object = triple.object.trim();
                let modifier = null;
                
                const modifiedMatch = object.match(/the '(.*?)' to '(.*?)'/i);
                if (modifiedMatch) {
                    return { source: modifiedMatch[1].trim(), target: modifiedMatch[2].trim(), type: predicate, modifier: source };
                }
                
                const predicateMatch = predicate.match(/(.*?)\s*\(\*\)/);
                if(predicateMatch){
                    object = object.replace(/\(\*\)/g, '').trim();
                }

                return { source, target: object.replace('(*)', '').trim(), type: predicateMatch ? predicateMatch[1].trim() : predicate, modifier };
            }).map(link => {
                const sourceNode = nodeMap.get(link.source);
                const targetNode = nodeMap.get(link.target);
                if (sourceNode && targetNode) {
                    return { ...link, source: sourceNode, target: targetNode };
                }
                console.warn(`Invalid link due to missing node, ignoring: '${link.source}' -> '${link.target}' in theory '${theory.name}'`);
                return null;
            }).filter(Boolean);

            runVisualization(nodes, links);
        }
        
        function runVisualization(nodes, links) {
            const width = graphContainer.clientWidth;
            const height = graphContainer.clientHeight;
            graphContainer.innerHTML = '';
            resetInfoPanel();

            const svg = d3.select(graphContainer).append("svg")
                .attr("viewBox", [-width / 2, -height / 2, width, height])
                .style("font", "12px sans-serif");
            
            svg.append("defs").selectAll("marker")
                .data(["influences", "positively influences", "negatively influences", "transitions to", "part of", "type of", "correlates with", "may influence"])
                .join("marker")
                    .attr("id", d => `arrow-${d.replace(/[\s/]+/g, '-')}`)
                    .attr("viewBox", "0 -5 10 10")
                    .attr("refX", 19)
                    .attr("refY", 0)
                    .attr("markerWidth", 6)
                    .attr("markerHeight", 6)
                    .attr("orient", "auto")
                .append("path")
                    .attr("d", "M0,-5L10,0L0,5")
                    .attr("fill", d => linkColor(d));

            const simulation = d3.forceSimulation(nodes)
                .force("link", d3.forceLink(links).distance(120))
                .force("charge", d3.forceManyBody().strength(-250))
                .force("x", d3.forceX())
                .force("y", d3.forceY());

            const linkElements = svg.append("g")
                .selectAll("line")
                .data(links)
                .join("line")
                .attr("class", "link")
                .attr("stroke", d => linkColor(d.type))
                .attr("stroke-width", 1.5)
                .attr("stroke-dasharray", d => d.modifier ? "5,5" : "none")
                .attr("marker-end", d => `url(#arrow-${d.type.replace(/[\s/]+/g, '-')})`);

            const nodeElements = svg.append("g")
                .selectAll("g")
                .data(nodes)
                .join("g")
                .attr("class", "node")
                .call(drag(simulation))
                .on("click", nodeClicked);
            
            nodeElements.append("circle")
                .attr("r", 8)
                .attr("fill", "#1F2937")
                .attr("stroke", "#4B5563")
                .attr("stroke-width", 1.5);
            
            nodeElements.append("text")
                .text(d => d.id)
                .attr("x", 12)
                .attr("y", 4)
                .attr("class", "node-label");
            
            simulation.on("tick", () => {
                linkElements
                    .attr("x1", d => d.source.x)
                    .attr("y1", d => d.source.y)
                    .attr("x2", d => d.target.x)
                    .attr("y2", d => d.target.y);
                nodeElements.attr("transform", d => `translate(${d.x},${d.y})`);
            });
            
            function drag(simulation) {
                function dragstarted(event, d) {
                    if (!event.active) simulation.alphaTarget(0.3).restart();
                    d.fx = d.x;
                    d.fy = d.y;
                }
                function dragged(event, d) {
                    d.fx = event.x;
                    d.fy = event.y;
                }
                function dragended(event, d) {
                    if (!event.active) simulation.alphaTarget(0);
                    d.fx = null;
                    d.fy = null;
                }
                return d3.drag().on("start", dragstarted).on("drag", dragged).on("end", dragended);
            }

            let selectedNode = null;

            function nodeClicked(event, d) {
                event.stopPropagation();
                if (selectedNode && selectedNode.id === d.id) {
                    selectedNode = null;
                    d3.selectAll('.node').classed('highlight', false).classed('highlight-neighbor', false);
                    d3.selectAll('.link').classed('highlight', false);
                    document.body.classList.remove('selecting');
                    resetInfoPanel();
                    return;
                }
                
                selectedNode = d;
                document.body.classList.add('selecting');
                updateInfoPanel(d, links);

                const connectedLinks = links.filter(l => l.source.id === d.id || l.target.id === d.id);
                const neighborIds = new Set(connectedLinks.flatMap(l => [l.source.id, l.target.id]));

                nodeElements.classed("highlight", n => n.id === d.id);
                nodeElements.classed("highlight-neighbor", n => neighborIds.has(n.id) && n.id !== d.id);
                linkElements.classed("highlight", l => l.source.id === d.id || l.target.id === d.id);
            }

            svg.on("click", () => {
                 if (selectedNode) {
                    selectedNode = null;
                    d3.selectAll('.node').classed('highlight', false).classed('highlight-neighbor', false);
                    d3.selectAll('.link').classed('highlight', false);
                    document.body.classList.remove('selecting');
                    resetInfoPanel();
                 }
            });
        }
        
        function updateInfoPanel(d, links) {
            const incoming = links.filter(l => l.target.id === d.id);
            const outgoing = links.filter(l => l.source.id === d.id);
            let html = `<h2 class="text-lg font-semibold text-white break-words">${d.id}</h2>`;
            html += `<div class="text-xs text-gray-400 mt-2 p-2 bg-gray-700/50 rounded-md font-mono break-words">${d.annotation}</div>`;
            html += `<div class="mt-4 space-y-4">`;
            if (outgoing.length > 0) {
                html += `<div><h3 class="font-semibold text-gray-300 mb-1">Influences / Leads to:</h3><ul class="list-disc list-inside space-y-1 text-sm">`;
                outgoing.forEach(l => {
                    html += `<li style="color:${linkColor(l.type)}"><span class="text-gray-200">${l.type} <strong class="font-medium">${l.target.id}</strong>${l.modifier ? ` (modified by ${l.modifier})` : ''}</span></li>`;
                });
                html += `</ul></div>`;
            }
            if (incoming.length > 0) {
                html += `<div><h3 class="font-semibold text-gray-300 mb-1">Is Influenced by:</h3><ul class="list-disc list-inside space-y-1 text-sm">`;
                incoming.forEach(l => {
                    html += `<li style="color:${linkColor(l.type)}"><span class="text-gray-200">${l.type} <strong class="font-medium">${l.source.id}</strong>${l.modifier ? ` (modified by ${l.modifier})` : ''}</span></li>`;
                });
                html += `</ul></div>`;
            }
            html += `</div>`;
            infoPanelContent.innerHTML = html;
        }

        function resetInfoPanel() {
            infoPanelContent.innerHTML = `
                <h2 class="text-lg font-semibold text-white mb-2">Select a Concept</h2>
                <p class="text-gray-300 text-sm">Click on a circle in the graph to see its details and relationships.</p>
                <div class="mt-6">
                    <h3 class="font-semibold text-gray-200 mb-2">Legend</h3>
                    <ul class="text-sm space-y-2 text-gray-400">
                        <li class="flex items-center"><svg width="20" height="10" class="mr-2"><line x1="0" y1="5" x2="20" y2="5" stroke="#60A5FA" stroke-width="2"></line></svg> influences</li>
                        <li class="flex items-center"><svg width="20" height="10" class="mr-2"><line x1="0" y1="5" x2="20" y2="5" stroke="#34D399" stroke-width="2"></line></svg> positively influences</li>
                        <li class="flex items-center"><svg width="20" height="10" class="mr-2"><line x1="0" y1="5" x2="20" y2="5" stroke="#F87171" stroke-width="2"></line></svg> negatively influences</li>
                        <li class="flex items-center"><svg width="20" height="10" class="mr-2"><line x1="0" y1="5" x2="20" y2="5" stroke="#F472B6" stroke-width="2"></line></svg> part of / type of</li>
                        <li class="flex items-center"><svg width="20" height="10" class="mr-2"><line x1="0" y1="5" x2="20" y2="5" stroke="#A78BFA" stroke-width="2"></line></svg> correlates with</li>
                        <li class="flex items-center"><svg width="20" height="10" class="mr-2"><line x1="0" y1="5" x2="20" y2="5" stroke="#FCD34D" stroke-width="2"></line></svg> transitions to</li>
                    </ul>
                </div>
            `;
        }

        function linkColor(type) {
            switch (type.toLowerCase()) {
                case 'influences': return '#60A5FA';
                case 'positively influences': return '#34D399';
                case 'negatively influences': return '#F87171';
                case 'part of': case 'type of': return '#F472B6';
                case 'correlates with': return '#A78BFA';
                case 'transitions to': return '#FCD34D';
                case 'may influence': return '#9CA3AF';
                default: return '#6B7280';
            }
        }
    </script>
</body>
</html>
